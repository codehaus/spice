<?xml version="1.0"?>
<project
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant">

    <preGoal name="site:generate">
        <attainGoal name="clover"/>
        <mkdir dir="${maven.docs.dest}"/>
        <copy todir="${maven.docs.dest}">
            <fileset dir="${basedir}/../../tools/site" filtering="no">
                <include name="images/*.gif"/>
            </fileset>
        </copy>
    </preGoal>

    <postGoal name="site:deploy">
        <exec dir="." executable="${maven.ssh.executable}">
            <arg line="${pom.siteAddress} -l ${maven.username} 'cd ${maven.homepage};chmod -R g+u . *'"/>
        </exec>
    </postGoal>

    <preGoal name="xdoc:transform">
        <attainGoal name="generateNavigation"/>
    </preGoal>

    <goal name="generateNavigation">
        <available
            file="${maven.docs.src}/navigation.xml"
            type="file"
            property="navigation.available" />

        <j:if test="${navigation.available != 'true'}" >
            <j:file name="target/navigation.xml" omitXmlDeclaration="true">
                <naproject name="${pom.name}">
                    <title>${pom.name}</title>
                    <body>
                        <links>
                            <item name="Spice" href="http://spice.sourceforge.net/"/>
                        </links>
                        <menu name="Overview">
                            <item name="Introduction" href="/index.html"/>
                        </menu>
                    </body>
                </naproject>
            </j:file>
            <style
                in="target/navigation.xml"
                out="${maven.docs.src}/navigation.xml"
                style="../../tools/navigation.xsl"/>
        </j:if>
    </goal>

    <postGoal name="dist:prepare-bin-filesystem">
        <attainGoal name="generateReadme"/>
        <copy todir="${maven.dist.bin.assembly.dir}">
            <fileset dir="../..">
                <include name="LICENSE.txt"/>
            </fileset>
        </copy>
        <copy todir="${maven.dist.bin.assembly.dir}">
            <fileset dir="target">
                <include name="README.txt"/>
            </fileset>
        </copy>
        <zip zipfile="${maven.dist.bin.assembly.dir}/src.zip">
            <fileset dir="src/java"/>
            <fileset dir="src/test"/>
        </zip>
    </postGoal>

    <goal name="buildDist">
        <attainGoal name="clean"/>
        <attainGoal name="dist:build-bin"/>
    </goal>

    <goal name="deployDist">
        <attainGoal name="buildDist"/>

        <!-- this doesn't actually work as optional task is not
             registered. It would be nice if it did but .... -->
        <ant:ftp server="upload.sourceforge.net"
            remotedir="/incoming"
            userid="anonymous"
            password="${maven.username}@users.sourceforge.net">
            <fileset dir="target/distributions"/>
        </ant:ftp>
    </goal>

    <goal name="generateReadme">
        <j:file name="target/README.txt" trim="false" omitXmlDeclaration="true">
        ----------------------------------------------------------------
        ${pom.name} - ${pom.shortDescription}
        ----------------------------------------------------------------

        ${pom.description}
        </j:file>
    </goal>

</project>